<script type="text/javascript">
    RED.nodes.registerType('knxUltimate', {
        category: 'KNX',
        color: '#7dd484',
        defaults: {
            //buttonState: {value: true},
            server: { type: "knxUltimate-config", required: true },
            topic: { value: "" },
            outputtopic: { value: "" },
            dpt: { value: "" },
            initialread: { value: false },
            notifyreadrequest: { value: false },
            notifyresponse: { value: false },
            notifywrite: { value: true },
            notifyreadrequestalsorespondtobus: { value: false },
            notifyreadrequestalsorespondtobusdefaultvalueifnotinitialized: { value: "0" },
            listenallga: { value: false },
            name: { value: "" },
            outputtype: { value: "write" },
            outputRBE: { value: true },
            inputRBE: { value: false },
            formatmultiplyvalue: { value: 1 },
            formatnegativevalue: { value: "leave" },
            formatdecimalsvalue: { value: 999 }
        },
        inputs: 1,
        outputs: 1,
        icon: "node-knx-icon.svg",
        label: function () {
            return (this.outputRBE == true ? "|rbe| " : "") + (this.name || this.topic || "knx-ultimate") + (this.inputRBE == true ? " |rbe|" : "")
        },
        paletteLabel: "KNX Device",
        // button: {
        //     enabled: function() {
        //         // return whether or not the button is enabled, based on the current
        //         // configuration of the node
        //         return !this.changed
        //     },
        //     visible: function() {
        //         // return whether or not the button is visible, based on the current
        //         // configuration of the node
        //         return this.hasButton
        //     },
        //     //toggle: "buttonState",
        //     onclick: function() {}
        // },
        oneditprepare: function () {
            var node = this;
            var oNodeServer= RED.nodes.node($("#node-input-server").val());; // Store the config-node
           
            // 19/02/2020 Used to alert the user if the CSV file has not been loaded and to get the server sooner als deploy
            $("#node-input-server").change(function () {
                try {
                    oNodeServer = RED.nodes.node($(this).val());
                    if (typeof oNodeServer.csv !== "undefined" && oNodeServer.csv !== "") {
                        $("#isETSFileLoaded").val("si");
                    } else {
                        $("#isETSFileLoaded").val("no");
                    }
                } catch (error) {
                    $("#isETSFileLoaded").val("no");
                }
            });

            $.getJSON("knxUltimateDpts", (data) => {
                data.forEach(dpt => {
                    $("#node-input-dpt").append($("<option></option>")
                        .attr("value", dpt.value)
                        .text(dpt.text))
                });
                $("#node-input-dpt").val(this.dpt)
            })

            // Add write and response as default for existing nodes like was default before
            if (typeof this.notifywrite === 'undefined') {
                this.notifywrite = true
                this.notifyresponse = true
                $("#node-input-notifywrite").prop("checked", true)
                $("#node-input-notifyresponse").prop("checked", true)
            }

            // Add Write as default for existing clients output
            if (typeof this.outputtype === 'undefined') {
                this.outputtype = "write"
                $("#node-input-outputtype").val("write")
            }

            $("#node-input-notifyreadrequest").on('change', function () {
                if ($("#node-input-notifyreadrequest").is(":checked")) {
                    if ($("#node-input-listenallga").is(":checked")) {
                    } else {
                        $("#divnotifyreadrequestautoreact").show();
                    }
                } else {
                    $("#divnotifyreadrequestautoreact").hide();
                }
            })

            $("#node-input-listenallga").on('change', function () {
                if ($("#node-input-listenallga").is(":checked")) {
                    $("#GAandDPT").hide()
                    $("#divOutputRBE").hide()
                    $("#node-input-outputRBE").prop('checked', false)
                    $("#divInputRBE").hide()
                    $("#node-input-inputRBE").prop('checked', false)
                    $("#divnotifyreadrequestautoreact").hide();
                    $("#helpallga").show();
                    $("#divTopic").hide()
                    if ($("#helpallga").html == "") {
                        // There is a ETS csv file, show the init read option
                        $("#divNode-input-initialread").show()
                    }
                    else {
                        // There isn't a ETS csv file, hide and deselect the init read option
                        $("#divNode-input-initialread").hide();
                        $("#node-input-initialread").prop('checked', false);
                    }
                } else {
                    $("#GAandDPT").show()
                    $("#divOutputRBE").show()
                    $("#divInputRBE").show()
                    $("#divTopic").show()
                    if ($("#node-input-notifyreadrequest").is(":checked")) {
                        $("#divnotifyreadrequestautoreact").show();
                    } else {
                        $("#divnotifyreadrequestautoreact").hide();
                    }
                    $("#helpallga").hide()
                    $("#divNode-input-initialread").show();
                }
            })

            // Autocomplete suggestion with ETS csv File
            $("#node-input-topic").autocomplete({
                minLength: 1,
                source: function (request, response) {
                    $.getJSON("knxUltimatecsv?nodeID=" + oNodeServer.id, (data) => {
                        response($.map(data, function (value, key) {
                            var sSearch = (value.ga + " (" + value.devicename + ") DPT" + value.dpt).toUpperCase();
                            if (sSearch.indexOf(request.term.toUpperCase()) != -1) {
                                return {
                                    label: value.ga + " # " + value.devicename + " # " + value.dpt, // Label for Display
                                    value: value.ga // Value
                                }
                            } else {
                                return null;
                            }
                        }));
                    });
                }, select: function (event, ui) {
                    // Sets Datapoint and device name automatically
                    var sDevName = ui.item.label.split("#")[1].trim();
                    try {
                        sDevName = sDevName.substr(sDevName.indexOf(")") + 1).trim();
                    } catch (error) {
                    }
                    $('#node-input-name').val(sDevName);
                    var optVal = $("#node-input-dpt option:contains('" + ui.item.label.split("#")[2].trim() + "')").attr('value');
                    // Select the option value 
                    $("#node-input-dpt").val(optVal);
                }
            });

            // Hide or show the GA and DPT fields if Notify on all Group Addresses is checked
            if (this.server) {
                if (typeof RED.nodes.node(this.server).csv !== 'undefined' && RED.nodes.node(this.server).csv != "") {
                    $("#helpallga").html("");
                    // There is a ETS csv file, show the init read option
                    $("#divNode-input-initialread").show()
                } else {
                    // 25/10/2019 Warn user that the node will node encode/decode datagram, if Listen All GA's if the config node doesn't contain the csv
                    $("#helpallga").html("<i> You haven't imported the ETS csv file. <br/> The node will work as blind transmitter/receiver. <a href=\"https://github.com/Supergiovane/node-red-contrib-knx-ultimate/wiki/2.-Node-Configuration\" target='_blank'>See the wiki about that</a>.</i>");
                    if ($("#node-input-listenallga").is(":checked")) {
                        // There isn't a ETS csv file, hide and deselect the init read option
                        $("#divNode-input-initialread").hide();
                        $("#node-input-initialread").prop('checked', false);
                    } else {
                        $("#divNode-input-initialread").show()
                    }
                }
            } else {
                $("#node-input-listenallga").prop("checked", false)
                $("#divTopic").show()
                $("#GAandDPT").show()
                $("#divOutputRBE").show()
                $("#divInputRBE").show()
                $("#helpallga").hide()
                $("#divNode-input-initialread").show()
            }

            // 02/01/2020 Advanced options Collapsible script
            // *****************************
            $("#advancedOptionsAccordion").accordion({
                header: "h3",
                heightStyle: "content",
                collapsible: true,
                active: false
            });
            // Auto open accordion if the default fields have been changed
            if (this.notifyreadrequest !== false ||
                this.notifyresponse !== false ||
                this.notifywrite !== true ||
                this.outputtype !== "write" ||
                this.outputRBE !== true ||
                this.inputRBE !== false
            ) {
                $("#advancedOptionsAccordion").accordion({ active: 0 });
            }
            // *****************************

            // 18/02/2020 KNX Value format Collapsible script
            // *****************************
            $("#formatValueAccordion").accordion({
                header: "h3",
                heightStyle: "content",
                collapsible: true,
                active: false
            });
            // *****************************

        },
        oneditsave: function () {
            var node = this;

            // 19/02/2020 Warn user that the node will node encode/decode datagram, if Listen All GA's if the config node doesn't contain the csv
            if ($("#isETSFileLoaded").val() === "no") {
                // Notify the user
                if ($("#node-input-listenallga").is(":checked")) {
                    var checkResult = "Universal mode (listen to all Group Addresses) needs a valid ETS csv to be able to decode datatypes and output device names. Please paste the ETS csv in the config node. If you don't use ETS csv file, the node will work as blind receiver (with automatic deconding of the datagrams) but you need to pass the datatype (besides the value) in the input message to be able to send something to the KNX BUS."
                    var myNotification = RED.notify(checkResult,
                        {
                            modal: true,
                            fixed: true,
                            type: 'error',
                            buttons: [
                                {
                                    text: "OK",
                                    click: function (e) {
                                        myNotification.close();
                                    }
                                }]
                        })
                }
                // $("#node-input-listenallga").prop("checked", false)
                // $("#GAandDPT").show()
                // $("#divOutputRBE").show()
                // $("#divInputRBE").show()
                $("#helpallga").show()
            }
        }
    })

</script>

<script type="text/x-red" data-template-name="knxUltimate">

    <!-- Setted by oneditprepare and used in oneditsave to warn th user if no CSV file has been loaded -->
<input id="isETSFileLoaded" name="isETSFileLoaded" type="hidden" value="false">

<div class="form-row">
    <label for="node-input-server"><img
            src="https://raw.githubusercontent.com/Supergiovane/node-red-contrib-knx-ultimate/master/img/config/connectioneibnettunneling.png"></i>
            <span data-i18n="knxUltimate.properties.node-input-server"></span> </label>
    <input type="text" id="node-input-server">
</div>
<div id="GAandDPT">
    <div class="form-row">
        <label for="node-input-topic"><img
                src="https://raw.githubusercontent.com/Supergiovane/node-red-contrib-knx-ultimate/master/img/config/subgroup.png"></i>
                <span data-i18n="knxUltimate.properties.node-input-topic"></span></label>
        <input type="text" id="node-input-topic" placeholder="Ex: 1/1/1">
    </div>
    <div class="form-row">
        <label for="node-input-dpt"><img
                src="https://raw.githubusercontent.com/Supergiovane/node-red-contrib-knx-ultimate/master/img/config/device.png"></i>
                <span data-i18n="knxUltimate.properties.node-input-dpt"></span> </label>
        <select id="node-input-dpt"></select>
    </div>
</div>
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="knxUltimate.properties.node-input-name"></span> </label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]knxUltimate.properties.node-input-name">
</div>
<div class="form-row" id="divTopic">
    <label for="node-input-outputtopic"><i class="fa fa-tasks"></i> <span data-i18n="knxUltimate.properties.node-input-outputtopic"></span> </label>
    <input type="text" id="node-input-outputtopic" data-i18n="[placeholder]knxUltimate.placeholder.leaveempty">
</div>
<div class="form-row">
    <input type="checkbox" id="node-input-listenallga" style="display:inline-block; width:auto; vertical-align:top;">
    <label style="width:auto" for="node-input-listenallga">&nbsp;&nbsp;<img
            src="https://raw.githubusercontent.com/Supergiovane/node-red-contrib-knx-ultimate/master/img/config/maingroup.png"></i>
            <span data-i18n="knxUltimate.properties.node-input-listenallga"></span></label>
    <div id="helpallga">Some Content Here</div>
</div>


<div id="advancedOptionsAccordion">
    <h3><span data-i18n="knxUltimate.advanced.Advancedoptions"></span></h3>
    <div>
        <p>
            <dt><i class="fa fa-code-fork"></i>&nbsp; <span data-i18n="knxUltimate.advanced.OUTPUT"></span></dt><br />
            <div class="form-row">
                <label for="node-input-outputtype"><i class="fa fa-rocket"></i> <span data-i18n="knxUltimate.properties.node-input-outputtype"></span> </label>
                <select id="node-input-outputtype">
                    <option value="write" data-i18n="knxUltimate.selectlists.Output_write"></option>
                    <option value="response" data-i18n="knxUltimate.selectlists.Output_response"></option>
                </select>
            </div>

            <div class="form-row" id="divOutputRBE">
                <input type="checkbox" id="node-input-outputRBE"
                    style="display:inline-block; width:auto; vertical-align:top;">
                <label style="width:auto" for="node-input-outputRBE">&nbsp;&nbsp;<i class="fa fa-filter"></i> <span data-i18n="knxUltimate.properties.node-input-outputRBE"></span></label>
            </div>

            <div class="form-row" id="divNode-input-initialread">
                <input type="checkbox" id="node-input-initialread"
                    style="display:inline-block; width:auto; vertical-align:top;">
                <label style="width:auto" for="node-input-initialread">&nbsp;&nbsp;<i
                        class="fa fa-question-circle-o"></i> <span data-i18n="knxUltimate.properties.node-input-initialread"></span></label>
            </div>


            <br />
            <dt><i class="fa fa-code-fork"></i>&nbsp; <span data-i18n="knxUltimate.advanced.INPUT"></span></dt><br />
            <div class="form-row" id="divInputRBE">
                <input type="checkbox" id="node-input-inputRBE"
                    style="display:inline-block; width:auto; vertical-align:top;">
                <label style="width:auto" for="node-input-inputRBE">&nbsp;&nbsp;<i class="fa fa-filter"></i> <span data-i18n="knxUltimate.properties.node-input-inputRBE"></span></label>
            </div>

            <div class="form-row">
                <input type="checkbox" id="node-input-notifywrite"
                    style="display:inline-block; width:auto; vertical-align:top;">
                <label style="width:auto" for="node-input-notifywrite">&nbsp;&nbsp;<i class="fa fa-sign-in"></i> <span data-i18n="knxUltimate.properties.node-input-notifywrite"></span></label>
            </div>

            <div class="form-row">
                <input type="checkbox" id="node-input-notifyresponse"
                    style="display:inline-block; width:auto; vertical-align:top;">
                <label style="width:auto" for="node-input-notifyresponse">&nbsp;&nbsp;<i class="fa fa-sign-in"></i>
                    <span data-i18n="knxUltimate.properties.node-input-notifyresponse"></span></label>
            </div>

            <div class="form-row">
                <input type="checkbox" id="node-input-notifyreadrequest"
                    style="display:inline-block; width:auto; vertical-align:top;">
                <label style="width:auto" for="node-input-notifyreadrequest">&nbsp;&nbsp;<i class="fa fa-sign-in"></i>
                    <span data-i18n="knxUltimate.properties.node-input-notifyreadrequest"></span></label>
            </div>

            <div id="divnotifyreadrequestautoreact">
                <dd>
                    <div class="form-row">
                        <input type="checkbox" id="node-input-notifyreadrequestalsorespondtobus"
                            style="display:inline-block; width:auto; vertical-align:top;">
                        <label style="width:auto" for="node-input-notifyreadrequestalsorespondtobus">&nbsp;&nbsp; <span data-i18n="knxUltimate.properties.node-input-notifyreadrequestalsorespondtobus"></span></label>
                    </div>
                    <div class="form-row">
                        <label style="width:auto">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span data-i18n="knxUltimate.properties.node-input-notifyreadrequestalsorespondtobusdefaultvalueifnotinitialized"></span></label>
                        <input style="width:auto" type="text"
                            id="node-input-notifyreadrequestalsorespondtobusdefaultvalueifnotinitialized"
                            data-i18n="[placeholder]knxUltimate.placeholder.notifyreadrequestalsorespondtobusdefaultvalueifnotinitialized">
                    </div>
                </dd>
            </div>
        </p>
    </div>
</div>

<div id="formatValueAccordion">
    <h3><span data-i18n="knxUltimate.advanced.Formatting"></span></h3>
    <div>
        <p>
            <dt><i class="fa fa-sort-numeric-asc"></i>&nbsp; <span data-i18n="knxUltimate.advanced.NUMERICVALUES"></span></dt>
            <br />
            <div class="form-row">
                <label for="node-input-formatmultiplyvalue"><i class="fa fa-calculator"></i> <span data-i18n="knxUltimate.properties.node-input-formatmultiplyvalue"></span> </label>
                <select id="node-input-formatmultiplyvalue">
                    <option value=1 data-i18n="knxUltimate.selectlists.Multiply_leave"></option>
                    <option value=0.001 data-i18n="knxUltimate.selectlists.Multiply_divide1000"></option>
                    <option value=0.01 data-i18n="knxUltimate.selectlists.Multiply_divide100"></option>
                    <option value=0.1 data-i18n="knxUltimate.selectlists.Multiply_divide10"></option>
                    <option value=10 data-i18n="knxUltimate.selectlists.Multiply_multiply10"></option>
                    <option value=100 data-i18n="knxUltimate.selectlists.Multiply_multiply100"></option>
                    <option value=1000 data-i18n="knxUltimate.selectlists.Multiply_multiply1000"></option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-formatdecimalsvalue"><i class="fa fa-expand"></i> <span data-i18n="knxUltimate.properties.node-input-formatdecimalsvalue"></span></label>
                <select id="node-input-formatdecimalsvalue">
                    <option value=999 data-i18n="knxUltimate.selectlists.Decimals_leave"></option>
                    <option value=0 data-i18n="knxUltimate.selectlists.Decimals_roundint"></option>
                    <option value=1 data-i18n="knxUltimate.selectlists.Decimals_round1"></option>
                    <option value=2 data-i18n="knxUltimate.selectlists.Decimals_round2"></option>
                    <option value=3 data-i18n="knxUltimate.selectlists.Decimals_round3"></option>
                    <option value=4 data-i18n="knxUltimate.selectlists.Decimals_round4"></option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-formatnegativevalue"><i class="fa fa-minus-circle"></i> <span data-i18n="knxUltimate.properties.node-input-formatnegativevalue"></span></label>
                <select id="node-input-formatnegativevalue">
                    <option value="leave" data-i18n="knxUltimate.selectlists.Negatives_leave"></option>
                    <option value="zero" data-i18n="knxUltimate.selectlists.Negatives_zero"></option>
                    <option value="abs" data-i18n="knxUltimate.selectlists.Negatives_abs"></option>
                </select>
            </div>

        </p>
    </div>
</div>
</script>

